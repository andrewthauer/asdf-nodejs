#!/usr/bin/env bash

set -o nounset -o pipefail -o errexit

install_nodejs() {
  local version="$1"
  local install_path="$2"

  # running this in a subshell
  # we don't want to disturb current working dir
  (
    node-build "$version" "$install_path" || exit 1

    mkdir -p "$install_path/lib/node_modules/.hooks"
    cp "$(dirname "$(dirname "$0")")"/npm-hooks/* "$install_path/lib/node_modules/.hooks/"
    chmod +x "$install_path"/lib/node_modules/.hooks/*
  )
}

install_default_npm_packages() {
  local default_npm_packages="${HOME}/.default-npm-packages"

  if [ ! -f $default_npm_packages ]; then return; fi

  for name in $(cat $default_npm_packages); do
    echo -ne "\nInstalling \e[33m${name}\e[39m npm package... "

    if npm install -g $name > /dev/null 2>&1; then
      echo -e "\e[32mSUCCESS\e[39m"
    else
      echo -e "\e[31mFAIL\e[39m"
    fi
  done
}

install_nodejs "$ASDF_INSTALL_VERSION" "$ASDF_INSTALL_PATH"
install_default_npm_packages
